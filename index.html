<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Soccer Playtime Tracker</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#10b981">
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --accent:#10b981;
  --muted:#94a3b8;
  --danger:#ef4444;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  color:#e6eef6;
  background:var(--bg);
  display:flex;
  flex-direction:column;
  height:100vh;
  overflow:hidden;
}

/* Header pinned top */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 12px;
  background:var(--card);
  flex-shrink:0;
  z-index:10;
}
.header input{
  flex:1;
  margin-right:12px;
  padding:10px;
  border-radius:8px;
  border:none;
  background:rgba(255,255,255,0.03);
  color:inherit;
  font-size:16px;
}
.header .gameclock{
  flex-shrink:0;
  font-weight:700;
  font-size:18px;
}

/* Scrollable player container */
.player-container{
  flex:1;
  overflow-y:auto;
  padding:8px 12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* Player row */
.player{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  border-radius:10px;
  background:rgba(255,255,255,0.02);
  position:relative;
  transition:background 0.2s;
}
.player.active{
  box-shadow: 0 0 0px 1px var(--accent);
}
.player.highlight{
  animation:highlightIn 1.2s ease-in-out;
}
@keyframes highlightIn{
  0%{background-color:rgba(16,185,129,0.4)}
  50%{background-color:rgba(16,185,129,0.15)}
  100%{background-color:rgba(0,0,0,0)}
}

.player .left{
  display:flex;
  align-items:center;
  gap:8px;
  flex:1;
  min-width:0;
}
.player-number,.player-name{
  padding:6px 8px;
  border-radius:6px;
  background:rgba(255,255,255,0.02);
  outline:none;
  font-weight:700;
}
.player-number{
    max-width: 30px;
    min-width: 30px;
  text-align:center;
}
.player-name{
  flex:1;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.controls{display:flex;align-items:center}
.controls button.icon{
  appearance:none;
  border:0;
  padding:6px 10px;
  border-radius:8px;
  background:rgba(255,255,255,0.03);
  color:inherit;
  font-weight:700;
  min-width:50px;
}
.time{
  width:60px;
  flex:0 0 60px;
  text-align:right;
  font-variant-numeric:tabular-nums;
    text-align: center;
    align-items: center;
    justify-content: center;
    height: 100%;
      display: flex;
    border-radius: 10px;
}
.player .time.active{
    font-weight: bold;
    background: var(--accent);
}

/* Add player row */
.add-player{
  display:flex;
  justify-content:center;
  padding:10px;
  border-radius:10px;
  background:rgba(16,185,129,0.1);
  color:var(--accent);
  cursor:pointer;
  font-weight:700;
}

/* Toolbar pinned bottom */
.toolbar{
    padding: 8px;
    background: var(--card);
    display: flex;
    justify-content: space-between;
    gap: 8px;
    flex-wrap: wrap;
    flex-shrink: 0;
    position: relative;
}
.toolbar .btn{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  background:rgba(255,255,255,0.03);
  color:inherit;
  font-weight:700;
}
.toolbar .btn.primary{
    background: linear-gradient(90deg, #06b6d4, #10b981);
    padding: 0px;
    display: flex;
    justify-self: anchor-center;
    box-shadow: 0 0 0 8px var(--card);
    height: 50px;
    align-items: anchor-center;
    flex-grow: 1;
    justify-content: center;
}

/* Modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:60}
.modal.open{display:flex}
.modal .sheet{
  width:calc(100% - 40px);
  max-width:520px;
  background:var(--card);
  border-radius:12px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.saved-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:60vh;
  overflow:auto;
  padding:6px;
}
.saved-item{
  padding:10px;
  border-radius:8px;
  background:rgba(255,255,255,0.02);
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <input id="gameInput" placeholder="Game ID">
  <div class="gameclock" id="gameClock">00:00</div>
</div>

<!-- Scrollable player container -->
<div class="player-container" id="players"></div>

<!-- Toolbar -->
<div class="toolbar">
  <button id="resetBtn" class="btn">Reset</button>
  <button id="togglePlay" class="btn primary"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 100 100">
  <polygon points="30,20 80,50 30,80" fill="white"/>
</svg>
</button>
  <button id="loadBtn" class="btn">Load</button>
</div>

<!-- Load Modal -->
<div id="loadModal" class="modal" aria-hidden>
  <div class="sheet">
    <h3>Game Options</h3>
    <button id="modalLoad" class="btn">Load Saved Game</button>
    <button id="modalDownload" class="btn">Download JSON</button>
    <button id="modalUpload" class="btn">Upload JSON</button>
    <div class="saved-list" id="savedList"></div>
    <input type="file" id="uploadInput" style="display:none" accept="application/json" multiple />
    <div style="display:flex;justify-content:flex-end;">
      <button id="closeModal" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
// --- Players Data ---
let initialPlayers=[
  {num:'26',name:'Alex'},{num:'00',name:'Miles'},{num:'00',name:'Julian'},
  {num:'00',name:'Benjamin'},{num:'00',name:'Judah'},{num:'00',name:'Sebastian'},
  {num:'00',name:'Kaison'},{num:'00',name:'Santiago'},{num:'00',name:'Maxwell'},
  {num:'00',name:'Ryan'},{num:'00',name:'Emerson'}
];

let players=[];
let gameSeconds=0, globalRunning=false, timerInterval=null;

// DOM
const playersEl=document.getElementById('players');
const gameInput=document.getElementById('gameInput');
const gameClockEl=document.getElementById('gameClock');
const loadModal=document.getElementById('loadModal');
const savedList=document.getElementById('savedList');
const uploadInput=document.getElementById('uploadInput');

if(!gameInput.value) gameInput.value='Game-'+cryptoRandomId();

// --- Utilities ---
function cryptoRandomId(){return Math.random().toString(36).slice(2,9);}
function fmt(s){const m=Math.floor(s/60).toString().padStart(2,'0');const sec=(s%60).toString().padStart(2,'0');return m+':'+sec;}
function storageKey(id){return 'game_'+id;}
function storageIndexKey(){return 'game_index';}

// --- Add New Player ---
function generateNewPlayerName(){
  let i=1;
  while(true){
    const name=`Player ${String(i).padStart(2,'0')}`;
    if(!players.some(p=>p.name===name)) return name;
    i++;
  }
}
function addNewPlayer(){
  const newPlayer={
    num:'00',
    name:generateNewPlayerName(),
    seconds:0,
    active:false,
    running:false,
    history:[],
    id:cryptoRandomId()
  };
  players.push(newPlayer);
  reorderAndRender();
  autoSave();
}

// --- Load most recent game ---
function loadMostRecentGame(){
  let idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]');
  if(idx.length===0){initializePlayers();return;}
  const latestId=idx[idx.length-1];
  const data=JSON.parse(localStorage.getItem(storageKey(latestId)));
  if(data){
    gameSeconds=data.gameSeconds||0;
    players=data.players||[];
    gameInput.value=data.id||('Game-'+cryptoRandomId());
  } else initializePlayers();
}
function initializePlayers(){
  players=initialPlayers.map(p=>({...p,seconds:0,active:false,running:false,history:[],id:cryptoRandomId()}));
}

// --- Render & Event Listeners ---
let removeMode=false; // Tracks if we're in "select players to remove" mode

function render(){
  gameClockEl.textContent=fmt(gameSeconds);
  playersEl.innerHTML='';

  players.forEach(p=>{
    const row=document.createElement('div'); 
    row.className='player'; 
    row.dataset.id=p.id;
    if(p.active) row.classList.add('active');

    const left=document.createElement('div'); 
    left.className='left';

    // Remove checkbox (only shown in removeMode)
    let checkbox;
    if(removeMode){
      checkbox=document.createElement('input');
      checkbox.type='checkbox';
      checkbox.style.marginRight='6px';
      checkbox.checked=p._markedForRemove||false;
      checkbox.addEventListener('change',()=>{p._markedForRemove=checkbox.checked;});
      left.appendChild(checkbox);
    }

    const num=document.createElement('div'); 
    num.className='player-number'; 
    num.contentEditable=true; 
    num.textContent=p.num;
    num.addEventListener('input',()=>{p.num=num.textContent.trim(); autoSave();});

    const name=document.createElement('div'); 
    name.className='player-name'; 
    name.contentEditable=true; 
    name.textContent=p.name;
    name.addEventListener('input',()=>{p.name=name.textContent.trim(); autoSave();});

    left.appendChild(num); 
    left.appendChild(name);
    row.appendChild(left);

    const controls=document.createElement('div'); 
    controls.className='controls';
    const subBtn=document.createElement('button'); 
    subBtn.className='icon'; 
    function updateBtn(){subBtn.textContent=p.active?'-':'+';}
    updateBtn();
    subBtn.addEventListener('click', ()=>{
      if(p.active){
        p.running=false; p.active=false; onMinus(p.id);
      } else {
        onPlus(p.id);
      }
      updateBtn();
      autoSave();
    });
    controls.appendChild(subBtn);
    row.appendChild(controls);

    const time=document.createElement('div'); 
    time.className='time'; 
    time.textContent=fmt(p.seconds);
    if(p.active) time.classList.add('active');
    row.appendChild(time);

    playersEl.appendChild(row);
  });

  // Add Player row
  const addRow=document.createElement('div'); 
  addRow.className='add-player'; 
  addRow.textContent='+ Add Player';
  addRow.addEventListener('click',addNewPlayer);
  playersEl.appendChild(addRow);

  // Remove Player row
  const removeRow=document.createElement('div'); 
  removeRow.className='add-player'; 
  removeRow.textContent='- Remove Player';
  removeRow.addEventListener('click',()=>{
    if(!removeMode){
      removeMode=true;
      reorderAndRender();
    } else {
      // Remove all marked players
      players=players.filter(p=>!p._markedForRemove);
      removeMode=false;
      reorderAndRender();
      autoSave();
    }
  });
  playersEl.appendChild(removeRow);
}


// --- Sorting ---
function reorderAndRender(){
  const activePlayers=players.filter(p=>p.active).sort((a,b)=>b.seconds-a.seconds);
  const inactivePlayers=players.filter(p=>!p.active).sort((a,b)=>b.seconds-a.seconds);
  players=[...activePlayers,...inactivePlayers];
  render();
}

// --- Player Controls ---
function onPlus(id){
  const p=players.find(x=>x.id===id); if(!p) return;
  p.active=true; if(globalRunning) p.running=true;
  p.history.push({in:gameSeconds});
  const row=[...playersEl.children].find(r=>r.dataset.id===id);
  if(row){row.classList.remove('highlight'); void row.offsetWidth; row.classList.add('highlight');}
  reorderAndRender();
}
function onMinus(id){
  const p=players.find(x=>x.id===id); if(!p) return;
  p.running=false; p.active=false;
  const last=p.history[p.history.length-1]; if(last && last.in && !last.out) last.out=gameSeconds;
  reorderAndRender();
}

// --- Timer ---
function startInterval(){
  if(players.filter(p=>p.active).length===0){return;}
  if(timerInterval) return;
  timerInterval=setInterval(()=>{
    if(globalRunning){
      gameSeconds++;
      players.forEach(p=>{if(p.running)p.seconds++;});
      if(players.filter(p=>p.active).length===0){ globalRunning=false; players.forEach(p=>p.running=false);}
      reorderAndRender();
      autoSave();
    }
  },1000);
}
function stopInterval(){if(timerInterval){clearInterval(timerInterval); timerInterval=null;}}

// --- Auto-save ---
function autoSave(){
  if(!gameInput.value) return;
  const id=gameInput.value.trim(); if(!id) return;
  const data={id,gameSeconds,players:players.map(p=>({...p})), timestamp:new Date().toISOString()};
  localStorage.setItem(storageKey(id),JSON.stringify(data));
  let idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]');
  if(!idx.includes(id)) idx.push(id);
  localStorage.setItem(storageIndexKey(),JSON.stringify(idx));
}
  
const playSVG = `
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 100 100">
  <polygon points="30,20 80,50 30,80" fill="white"/>
</svg>`;

const pauseSVG = `
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 100 100">
  <rect x="30" y="20" width="15" height="60" fill="white"/>
  <rect x="55" y="20" width="15" height="60" fill="white"/>
</svg>
`;
  
// --- Toolbar ---
const togglePlayBtn = document.getElementById('togglePlay');
togglePlayBtn.addEventListener('click', () => {
  // Do not start if no active players
  if (players.filter(p => p.active).length === 0) return;

  globalRunning = !globalRunning;
  players.forEach(p => { if (p.active) p.running = globalRunning; });
  
  togglePlayBtn.innerHTML = globalRunning ? pauseSVG : playSVG;

  if (globalRunning) startInterval();
  autoSave();
});
document.getElementById('resetBtn').addEventListener('click',()=>{
  if(confirm('Reset game?')){
    gameSeconds=0; globalRunning=false;
    players.forEach(p=>{p.active=false; p.running=false; p.seconds=0; p.history=[]});
    gameInput.value='Game-'+cryptoRandomId();
    render();
    autoSave();
  }
});

// --- Load Modal ---
const loadBtn=document.getElementById('loadBtn');
const closeModal=document.getElementById('closeModal');
loadBtn.addEventListener('click',()=>{loadModal.classList.add('open'); populateSavedList();});
closeModal.addEventListener('click',()=>{loadModal.classList.remove('open');});
function populateSavedList(){
  savedList.innerHTML='';
  const idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]');
  idx.forEach(id=>{
    const item=document.createElement('div'); item.className='saved-item';
    item.textContent=id;
    item.addEventListener('click',()=>{
      const data=JSON.parse(localStorage.getItem(storageKey(id)));
      if(data){gameSeconds=data.gameSeconds||0; players=data.players||[]; gameInput.value=data.id||('Game-'+cryptoRandomId()); globalRunning=false; players.forEach(p=>p.running=false); reorderAndRender(); loadModal.classList.remove('open'); autoSave();}
    });
    savedList.appendChild(item);
  });
}
document.getElementById('modalDownload').addEventListener('click',()=>{
  const idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]');
  const data=idx.map(id=>JSON.parse(localStorage.getItem(storageKey(id))));
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='games.json'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('modalUpload').addEventListener('click',()=>uploadInput.click());
uploadInput.addEventListener('change',(e)=>{
  const files=Array.from(e.target.files);
  files.forEach(f=>{
    const reader=new FileReader();
    reader.onload=()=>{try{const arr=JSON.parse(reader.result); arr.forEach(g=>{if(g.id) localStorage.setItem(storageKey(g.id),JSON.stringify(g));}); autoSave(); populateSavedList();}catch(err){alert('Invalid JSON');}};
    reader.readAsText(f);
  });
});

// --- Initialize ---
loadMostRecentGame();
reorderAndRender();
startInterval();

// --- PWA: Service Worker ---
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('service-worker.js')
      .then(reg=>console.log('Service Worker registered:',reg.scope))
      .catch(err=>console.log('Service Worker registration failed:',err));
  });
}
</script>
</body>
</html>
