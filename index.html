<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Soccer Playtime Tracker</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--accent:#10b981;--muted:#94a3b8;--danger:#ef4444}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071126 0%, #06121b 100%);color:#e6eef6;display:flex;flex-direction:column}
.container{flex:1;display:flex;flex-direction:column;padding:12px;gap:8px;max-width:900px;margin:0 auto;width:100%}
#gameInput{width:100%;box-sizing:border-box;padding:14px 12px;border-radius:10px;border:0;font-size:18px;background:rgba(255,255,255,0.03);color:inherit}
.gameclock{width:100%;text-align:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.03);font-weight:700;font-size:20px}
.players{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.player{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 1px 0 rgba(255,255,255,0.02);width:100%}
.player .left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.player-number, .player-name{border-radius:8px;padding:8px;background:rgba(255,255,255,0.02);font-weight:700;outline:none}
.player-number{width:56px;text-align:center;flex:0 0 56px}
.player-name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.indicator{width:14px;height:14px;border-radius:50%;background:var(--muted);box-shadow:0 0 6px rgba(0,0,0,0.6)}
.indicator.active{background:var(--accent);box-shadow:0 0 10px rgba(16,185,129,0.35)}
.controls{display:flex;gap:8px;align-items:center}
button.icon{appearance:none;border:0;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.03);color:inherit;font-weight:700;font-size:16px;min-width:48px}
button.icon:active{transform:translateY(1px)}
.time{width:78px;flex:0 0 78px;text-align:right;font-variant-numeric:tabular-nums}
.toolbar{position:fixed;left:0;right:0;bottom:0;padding:8px;background:linear-gradient(180deg, rgba(5,10,18,0.9), rgba(5,10,18,1));display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap}
.toolbar .btn{padding:12px 16px;border-radius:12px;border:0;background:rgba(255,255,255,0.03);color:inherit;font-weight:700;font-size:16px}
.toolbar .btn.primary{background:linear-gradient(90deg,#06b6d4,#10b981)}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:40}
.modal.open{display:flex}
.modal .sheet{width:calc(100% - 40px);max-width:520px;background:var(--card);border-radius:12px;padding:12px;}
.saved-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:6px}
.saved-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
@media(min-width:720px){body{padding:20px} .container{padding:0}}
</style>
</head>
<body>
<div class="container">
  <input id="gameInput" placeholder="Enter Game ID (unique)" />
  <div id="gameClock" class="gameclock">Game: <span id="gameIdLabel">(no id)</span> — 00:00</div>
  <div class="players" id="players"></div>
</div>

<div class="toolbar" role="toolbar" aria-label="controls">
  <button id="pauseAll" class="btn">Pause</button>
  <button id="playAll" class="btn primary">Play</button>
  <button id="saveBtn" class="btn">Save</button>
  <button id="resetBtn" class="btn">Reset</button>
  <button id="loadBtn" class="btn">Load</button>
  <button id="downloadBtn" class="btn">Download JSON</button>
  <input type="file" id="uploadInput" style="display:none" accept="application/json" multiple />
  <button id="uploadBtn" class="btn">Upload JSON</button>
</div>

<div id="loadModal" class="modal" aria-hidden>
  <div class="sheet">
    <h3>Saved Games</h3>
    <div class="saved-list" id="savedList"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="deleteAllBtn" class="btn" style="background:var(--danger);">Delete All</button>
      <button id="closeModal" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
const initialPlayers=[{num:'26',name:'Alex'},{num:'00',name:'Miles'},{num:'00',name:'Julian'},
{num:'00',name:'Benjamin'},{num:'00',name:'Judah'},{num:'00',name:'Sebastian'},{num:'00',name:'Kaison'},
{num:'00',name:'Santiago'},{num:'00',name:'Maxwell'},{num:'00',name:'Ryan'},{num:'00',name:'Emerson'}];

let players=initialPlayers.map(p=>({...p,seconds:0,active:false,running:false,history:[],id:cryptoRandomId()}));
let gameSeconds=0;
let globalRunning=false;
let timerInterval=null;

const playersEl=document.getElementById('players');
const gameInput=document.getElementById('gameInput');
const gameIdLabel=document.getElementById('gameIdLabel');
const savedList=document.getElementById('savedList');
const loadModal=document.getElementById('loadModal');

function cryptoRandomId(){return Math.random().toString(36).slice(2,9);}
function fmt(s){const mm=Math.floor(s/60).toString().padStart(2,'0');const ss=(s%60).toString().padStart(2,'0');return mm+':'+ss;}
function storageKey(id){return 'soccer_play_tracker:'+id;}
function storageIndexKey(){return 'soccer_play_tracker:index';}

function saveToStorage(){
  const gameId=(gameInput.value||'').trim();
  if(!gameId){return;}
  const key=storageKey(gameId);
  const payload={gameSeconds,players:players.map(p=>({num:p.num,name:p.name,seconds:p.seconds,history:p.history})),timestamp:new Date().toLocaleString()};
  localStorage.setItem(key,JSON.stringify(payload));
  let idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]');
  if(!idx.includes(gameId)) idx.push(gameId);
  localStorage.setItem(storageIndexKey(),JSON.stringify(idx));
  renderSavedList();
}

function saveToStorageIfHasId(){ if(gameInput.value.trim()) saveToStorage(); }

function render(){
  gameIdLabel.textContent=gameInput.value||'(no id)';
  playersEl.innerHTML='';
  players.forEach(p=>{
    const row=document.createElement('div'); row.className='player';
    const left=document.createElement('div'); left.className='left';
    const num=document.createElement('div'); num.className='player-number'; num.contentEditable=true; num.textContent=p.num;
    num.addEventListener('input',()=>{p.num=num.textContent.trim();saveToStorageIfHasId();});
    const name=document.createElement('div'); name.className='player-name'; name.contentEditable=true; name.textContent=p.name;
    name.addEventListener('input',()=>{p.name=name.textContent.trim();saveToStorageIfHasId();});
    const indicator=document.createElement('div'); indicator.className='indicator'; if(p.active) indicator.classList.add('active');
    left.appendChild(num); left.appendChild(name); left.appendChild(indicator);

    const controls=document.createElement('div'); controls.className='controls';
    const plus=document.createElement('button'); plus.className='icon'; plus.textContent='+';
    plus.addEventListener('click',()=>onPlus(p.id));
    const minus=document.createElement('button'); minus.className='icon'; minus.textContent='-';
    minus.addEventListener('click',()=>onMinus(p.id));
    const time=document.createElement('div'); time.className='time'; time.textContent=fmt(p.seconds);
    controls.appendChild(plus); controls.appendChild(minus);

    row.appendChild(left); row.appendChild(controls); row.appendChild(time);
    playersEl.appendChild(row);
  });
  document.getElementById('gameClock').innerHTML=`Game: <strong>${gameInput.value||'(no id)'}</strong> — ${fmt(gameSeconds)}`;
}

// Sorting active/inactive and by playtime
function reorderAndRender(){
  const activePlayers = players.filter(p=>p.active).sort((a,b)=>b.seconds-a.seconds);
  const inactivePlayers = players.filter(p=>!p.active).sort((a,b)=>b.seconds-a.seconds);
  players=[...activePlayers,...inactivePlayers];
  render();
}

function onPlus(id){
  const p=players.find(x=>x.id===id); if(!p) return;
  p.active=true; if(globalRunning) p.running=true;
  p.history.push({in:gameSeconds});
  reorderAndRender(); saveToStorageIfHasId();
}

function onMinus(id){
  const p=players.find(x=>x.id===id); if(!p) return;
  p.running=false; p.active=false;
  const last=p.history[p.history.length-1]; if(last && last.in && !last.out) last.out=gameSeconds;
  reorderAndRender(); saveToStorageIfHasId();
}

function startInterval(){
  if(timerInterval) return;
  timerInterval=setInterval(()=>{
    if(globalRunning){
      gameSeconds++;
      players.forEach(p=>{if(p.running)p.seconds++;});
      reorderAndRender();
      saveToStorageIfHasId(); // Save every second while gameclock is running
    }
  },1000);
}

function stopInterval(){if(timerInterval){clearInterval(timerInterval); timerInterval=null;}}

document.getElementById('playAll').addEventListener('click',()=>{
  globalRunning=true;
  players.forEach(p=>{if(p.active)p.running=true});
  startInterval();
  saveToStorageIfHasId();
});

document.getElementById('pauseAll').addEventListener('click',()=>{
  globalRunning=false;
  players.forEach(p=>p.running=false);
  saveToStorageIfHasId();
});

document.getElementById('saveBtn').addEventListener('click',()=>saveToStorage());

document.getElementById('resetBtn').addEventListener('click',()=>{
  if(!confirm('Reset current game?')) return;
  const old=(gameInput.value||'').trim(); const newName=bumpName(old||'Game'); gameInput.value=newName;
  gameSeconds=0; globalRunning=false;
  players.forEach(p=>{p.seconds=0; p.active=false; p.running=false; p.history=[]});
  render(); saveToStorageIfHasId();
});

function bumpName(name){ const m=name.match(/^(.*) (\d+)$/); return m? m[1]+" "+(parseInt(m[2])+1): name+" 1"; }

document.getElementById('loadBtn').addEventListener('click',()=>{ renderSavedList(); loadModal.classList.add('open'); });
document.getElementById('closeModal').addEventListener('click',()=>loadModal.classList.remove('open'));

function renderSavedList(){
  savedList.innerHTML=''; let idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]');
  idx.sort((a,b)=>{ const aTS=JSON.parse(localStorage.getItem(storageKey(a))||'{}').timestamp; const bTS=JSON.parse(localStorage.getItem(storageKey(b))||'{}').timestamp; return new Date(bTS)-new Date(aTS); });
  if(idx.length===0){ savedList.innerHTML='<div>No saved games</div>'; return; }
  idx.forEach(id=>{
    const raw=localStorage.getItem(storageKey(id)); if(!raw) return;
    const obj=JSON.parse(raw);
    const el=document.createElement('div'); el.className='saved-item';
    el.innerHTML=`<input type="checkbox" class="selectGame"> <strong>${id}</strong> <span>${obj.timestamp}</span>`;
    const loadBtn=document.createElement('button'); loadBtn.className='btn'; loadBtn.textContent='Load'; loadBtn.addEventListener('click',()=>loadGame(id));
    const deleteBtn=document.createElement('button'); deleteBtn.className='btn'; deleteBtn.style.background='var(--danger)'; deleteBtn.textContent='Delete';
    deleteBtn.addEventListener('click',()=>{if(confirm('Delete this game?')){ localStorage.removeItem(storageKey(id)); let index=JSON.parse(localStorage.getItem(storageIndexKey())||'[]'); index=index.filter(x=>x!==id); localStorage.setItem(storageIndexKey(),JSON.stringify(index)); renderSavedList();}});
    el.appendChild(loadBtn); el.appendChild(deleteBtn); savedList.appendChild(el);
  });
}

function loadGame(id){
  const raw=localStorage.getItem(storageKey(id)); if(!raw) return;
  const obj=JSON.parse(raw);
  players=obj.players.map(p=>({...p, active:false, running:false, id:cryptoRandomId()}));
  gameSeconds=obj.gameSeconds||0; globalRunning=false; gameInput.value=id; render(); loadModal.classList.remove('open');
}

document.getElementById('downloadBtn').addEventListener('click',()=>{
  const checkboxes=savedList.querySelectorAll('.selectGame'); const selected=[];
  checkboxes.forEach(c=>{if(c.checked){ const id=c.parentElement.querySelector('strong').textContent; selected.push(JSON.parse(localStorage.getItem(storageKey(id))));}});
  if(selected.length===0){alert('No games selected'); return;}
  const blob=new Blob([JSON.stringify(selected,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='games.json'; a.click();
});

document.getElementById('uploadBtn').addEventListener('click',()=>document.getElementById('uploadInput').click());
document.getElementById('uploadInput').addEventListener('change',e=>{
  const files=[...e.target.files]; if(!files.length) return;
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=()=>{ try{ const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) return; arr.forEach(obj=>{ const id=obj.id||cryptoRandomId(); if(localStorage.getItem(storageKey(id)) && !confirm(`Game ID ${id} exists. Overwrite?`)) return; localStorage.setItem(storageKey(id), JSON.stringify(obj)); let idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]'); if(!idx.includes(id)) idx.push(id); localStorage.setItem(storageIndexKey(),JSON.stringify(idx));}); renderSavedList();}catch(err){alert('Invalid JSON');}};
    reader.readAsText(file);
  });
});

document.getElementById('deleteAllBtn').addEventListener('click',()=>{
  if(confirm('Delete ALL saved games?')){ const idx=JSON.parse(localStorage.getItem(storageIndexKey())||'[]'); idx.forEach(id=>localStorage.removeItem(storageKey(id))); localStorage.setItem(storageIndexKey(),JSON.stringify([])); renderSavedList(); }
});

render();
</script>
</body>
</html>
